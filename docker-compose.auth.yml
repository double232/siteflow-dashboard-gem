# OAuth2 Proxy configuration for SiteFlow Dashboard
# Use with: docker compose -f docker-compose.yml -f docker-compose.auth.yml up -d
#
# Required environment variables:
#   OAUTH2_CLIENT_ID - Google OAuth2 client ID
#   OAUTH2_CLIENT_SECRET - Google OAuth2 client secret
#   OAUTH2_COOKIE_SECRET - Random 32-byte secret (generate with: openssl rand -base64 32)
#   OAUTH2_ALLOWED_EMAILS - Comma-separated list of allowed email addresses
#   DASHBOARD_DOMAIN - Dashboard domain (e.g., dashboard.double232.com)

services:
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: siteflow-auth
    restart: unless-stopped
    command:
      - --provider=google
      - --email-domain=*
      - --authenticated-emails-file=/etc/oauth2-proxy/allowed-emails.txt
      - --upstream=http://siteflow:8000
      - --http-address=0.0.0.0:4180
      - --cookie-secure=true
      - --cookie-httponly=true
      - --cookie-samesite=lax
      - --cookie-name=_siteflow_auth
      - --session-cookie-minimal=true
      - --skip-provider-button=true
      - --reverse-proxy=true
      - --set-xauthrequest=true
      - --pass-access-token=false
      - --pass-authorization-header=false
      - --skip-auth-route=^/api/ping$
      - --skip-auth-route=^/api/backups/runs$
    environment:
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_COOKIE_SECRET}
      - OAUTH2_PROXY_REDIRECT_URL=https://${DASHBOARD_DOMAIN}/oauth2/callback
    volumes:
      - ./auth/allowed-emails.txt:/etc/oauth2-proxy/allowed-emails.txt:ro
    depends_on:
      - siteflow
    labels:
      caddy: ${DASHBOARD_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 4180}}"
    networks:
      - siteflow
      - web_proxy

  # Override siteflow to remove direct caddy labels (proxy handles routing)
  siteflow:
    labels: []
